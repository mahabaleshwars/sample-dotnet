name: Validate Channel + Quality Behavior for Issue 497

on:
  workflow_dispatch:

jobs:
  # ============================================================
  # CASE 1: Numeric channels + quality (should work correctly)
  # Confirms: dotnet-version: latest (resolved to numeric channel)
  # can support dotnet-quality
  # ============================================================
  numeric-channel-quality-unix:
    name: "âœ… Numeric: Channel ${{ matrix.channel }} + Quality ${{ matrix.quality }} (${{ matrix.os }})"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        channel: ['9.0', '10.0']
        quality: ['ga', 'preview', 'daily']
    steps:
      - name: Install .NET SDK (channel=${{ matrix.channel }}, quality=${{ matrix.quality }})
        shell: bash
        run: |
          ARGS="--channel ${{ matrix.channel }} --install-dir $HOME/.dotnet-test"
          if [ "${{ matrix.quality }}" != "ga" ]; then
            ARGS="$ARGS --quality ${{ matrix.quality }}"
          fi
          echo "Running: dotnet-install.sh $ARGS"
          curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin $ARGS

      - name: Verify SDK version and quality
        shell: bash
        run: |
          SDK_VERSION=$($HOME/.dotnet-test/dotnet --version)
          echo "Installed SDK version: $SDK_VERSION"
          echo "Channel: ${{ matrix.channel }}, Quality: ${{ matrix.quality }}"

          # Verify major.minor matches the channel
          if [[ "$SDK_VERSION" == ${{ matrix.channel }}* ]]; then
            echo "âœ… SDK version matches channel ${{ matrix.channel }}"
          else
            echo "âŒ SDK version $SDK_VERSION does not match channel ${{ matrix.channel }}"
            exit 1
          fi

          # Verify quality expectations
          case "${{ matrix.quality }}" in
            ga)
              if [[ "$SDK_VERSION" == *"-preview"* ]] || [[ "$SDK_VERSION" == *"-daily"* ]] || [[ "$SDK_VERSION" == *"-rc"* ]]; then
                echo "âŒ GA quality should not contain preview/daily/rc tags"
                exit 1
              else
                echo "âœ… GA version confirmed (no preview/daily/rc tags)"
              fi
              ;;
            preview)
              echo "â„¹ï¸ Preview quality â€” version may contain preview/rc tag: $SDK_VERSION"
              ;;
            daily)
              echo "â„¹ï¸ Daily quality â€” version may contain daily tag: $SDK_VERSION"
              ;;
          esac

          $HOME/.dotnet-test/dotnet --list-sdks

  numeric-channel-quality-windows:
    name: "âœ… Numeric: Channel ${{ matrix.channel }} + Quality ${{ matrix.quality }} (windows-latest)"
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        channel: ['9.0', '10.0']
        quality: ['ga', 'preview', 'daily']
    steps:
      - name: Install .NET SDK via PowerShell (channel=${{ matrix.channel }}, quality=${{ matrix.quality }})
        shell: pwsh
        run: |
          $installDir = "$env:USERPROFILE\.dotnet-test"
          $params = @{
            Channel    = "${{ matrix.channel }}"
            InstallDir = $installDir
          }
          if ("${{ matrix.quality }}" -ne "ga") {
            $params["Quality"] = "${{ matrix.quality }}"
          }

          $scriptContent = Invoke-RestMethod https://dot.net/v1/dotnet-install.ps1
          $scriptBlock = [scriptblock]::Create($scriptContent)

          Write-Host "Running: dotnet-install.ps1 -Channel ${{ matrix.channel }} -Quality ${{ matrix.quality }}"
          & $scriptBlock @params

      - name: Verify SDK version and quality
        shell: pwsh
        run: |
          $installDir = "$env:USERPROFILE\.dotnet-test"
          $sdkVersion = & "$installDir\dotnet.exe" --version
          Write-Host "Installed SDK version: $sdkVersion"
          Write-Host "Channel: ${{ matrix.channel }}, Quality: ${{ matrix.quality }}"

          # Verify major.minor matches the channel
          if ($sdkVersion.StartsWith("${{ matrix.channel }}")) {
            Write-Host "âœ… SDK version matches channel ${{ matrix.channel }}"
          } else {
            Write-Host "âŒ SDK version $sdkVersion does not match channel ${{ matrix.channel }}"
            exit 1
          }

          # Verify quality expectations
          switch ("${{ matrix.quality }}") {
            "ga" {
              if ($sdkVersion -match "(preview|daily|rc)") {
                Write-Host "âŒ GA quality should not contain preview/daily/rc tags"
                exit 1
              } else {
                Write-Host "âœ… GA version confirmed (no preview/daily/rc tags)"
              }
            }
            "preview" {
              Write-Host "â„¹ï¸ Preview quality â€” version may contain preview/rc tag: $sdkVersion"
            }
            "daily" {
              Write-Host "â„¹ï¸ Daily quality â€” version may contain daily tag: $sdkVersion"
            }
          }

          & "$installDir\dotnet.exe" --list-sdks

  # ============================================================
  # CASE 2: LTS/STS alias channels silently ignore quality
  # Confirms: dotnet-version: latest-lts + dotnet-quality won't
  # work as expected â€” action should warn
  # ============================================================
  alias-channel-quality-ignored-unix:
    name: "âš ï¸ Alias: Channel ${{ matrix.channel }} + Quality ${{ matrix.quality }} (ubuntu-latest)"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        channel: ['LTS', 'STS']
        quality: ['ga', 'preview', 'daily']
    steps:
      - name: Install .NET SDK (channel=${{ matrix.channel }}, quality=${{ matrix.quality }})
        shell: bash
        run: |
          echo "âš ï¸ Testing: --channel ${{ matrix.channel }} --quality ${{ matrix.quality }}"
          echo "Expected: --quality will be SILENTLY IGNORED for alias channels"
          echo ""
          curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin \
            --channel ${{ matrix.channel }} \
            --quality ${{ matrix.quality }} \
            --install-dir $HOME/.dotnet-test-${{ matrix.channel }}-${{ matrix.quality }}

      - name: Record installed version
        id: version
        shell: bash
        run: |
          SDK_VERSION=$($HOME/.dotnet-test-${{ matrix.channel }}-${{ matrix.quality }}/dotnet --version)
          echo "SDK_VERSION=$SDK_VERSION" >> "$GITHUB_OUTPUT"
          echo "Installed SDK version: $SDK_VERSION"
          echo "Channel: ${{ matrix.channel }}, Quality: ${{ matrix.quality }}"

  alias-channel-quality-ignored-windows:
    name: "âš ï¸ Alias: Channel ${{ matrix.channel }} + Quality ${{ matrix.quality }} (windows-latest)"
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        channel: ['LTS', 'STS']
        quality: ['ga', 'preview', 'daily']
    steps:
      - name: Install .NET SDK via PowerShell (channel=${{ matrix.channel }}, quality=${{ matrix.quality }})
        shell: pwsh
        run: |
          Write-Host "âš ï¸ Testing: -Channel ${{ matrix.channel }} -Quality ${{ matrix.quality }}"
          Write-Host "Expected: -Quality will be SILENTLY IGNORED for alias channels"
          Write-Host ""

          $installDir = "$env:USERPROFILE\.dotnet-test-${{ matrix.channel }}-${{ matrix.quality }}"
          $scriptContent = Invoke-RestMethod https://dot.net/v1/dotnet-install.ps1
          $scriptBlock = [scriptblock]::Create($scriptContent)

          & $scriptBlock -Channel ${{ matrix.channel }} -Quality ${{ matrix.quality }} -InstallDir $installDir

      - name: Record installed version
        id: version
        shell: pwsh
        run: |
          $installDir = "$env:USERPROFILE\.dotnet-test-${{ matrix.channel }}-${{ matrix.quality }}"
          $sdkVersion = & "$installDir\dotnet.exe" --version
          Write-Host "Installed SDK version: $sdkVersion"
          Write-Host "Channel: ${{ matrix.channel }}, Quality: ${{ matrix.quality }}"
          "SDK_VERSION=$sdkVersion" >> $env:GITHUB_OUTPUT

  # ============================================================
  # CASE 2 PROOF: Compare versions to prove quality was ignored
  # ============================================================
  prove-quality-ignored:
    name: "ðŸ” Proof: Alias channels ignore quality"
    runs-on: ubuntu-latest
    needs: [alias-channel-quality-ignored-unix]
    steps:
      - name: Install with LTS + ga, LTS + preview, LTS + daily
        shell: bash
        run: |
          for quality in ga preview daily; do
            echo "--- Installing --channel LTS --quality $quality ---"
            curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin \
              --channel LTS \
              --quality $quality \
              --install-dir $HOME/.dotnet-lts-$quality
          done

      - name: Install with STS + ga, STS + preview, STS + daily
        shell: bash
        run: |
          for quality in ga preview daily; do
            echo "--- Installing --channel STS --quality $quality ---"
            curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin \
              --channel STS \
              --quality $quality \
              --install-dir $HOME/.dotnet-sts-$quality
          done

      - name: Compare all versions â€” prove quality is ignored
        shell: bash
        run: |
          echo "============================================"
          echo "  PROOF: Quality is ignored for LTS/STS"
          echo "============================================"
          echo ""

          LTS_GA=$($HOME/.dotnet-lts-ga/dotnet --version)
          LTS_PREVIEW=$($HOME/.dotnet-lts-preview/dotnet --version)
          LTS_DAILY=$($HOME/.dotnet-lts-daily/dotnet --version)

          STS_GA=$($HOME/.dotnet-sts-ga/dotnet --version)
          STS_PREVIEW=$($HOME/.dotnet-sts-preview/dotnet --version)
          STS_DAILY=$($HOME/.dotnet-sts-daily/dotnet --version)

          echo "| Channel | Quality  | Installed Version |"
          echo "|---------|----------|-------------------|"
          echo "| LTS     | ga       | $LTS_GA           |"
          echo "| LTS     | preview  | $LTS_PREVIEW      |"
          echo "| LTS     | daily    | $LTS_DAILY        |"
          echo "| STS     | ga       | $STS_GA           |"
          echo "| STS     | preview  | $STS_PREVIEW      |"
          echo "| STS     | daily    | $STS_DAILY        |"
          echo ""

          # Verify all LTS versions are identical
          FAILED=false
          if [[ "$LTS_GA" == "$LTS_PREVIEW" && "$LTS_GA" == "$LTS_DAILY" ]]; then
            echo "âš ï¸ CONFIRMED: All LTS versions are identical ($LTS_GA) â€” quality was silently ignored"
          else
            echo "âŒ UNEXPECTED: LTS versions differ â€” quality may NOT be ignored"
            FAILED=true
          fi

          # Verify all STS versions are identical
          if [[ "$STS_GA" == "$STS_PREVIEW" && "$STS_GA" == "$STS_DAILY" ]]; then
            echo "âš ï¸ CONFIRMED: All STS versions are identical ($STS_GA) â€” quality was silently ignored"
          else
            echo "âŒ UNEXPECTED: STS versions differ â€” quality may NOT be ignored"
            FAILED=true
          fi

          echo ""
          if [ "$FAILED" = true ]; then
            echo "ðŸ”´ Result: Quality may NOT be ignored for alias channels â€” needs further investigation"
            exit 1
          else
            echo "ðŸŸ¡ Result: Quality IS silently ignored for alias channels (LTS/STS)"
            echo "   â†’ Action should WARN users when dotnet-quality is used with latest-lts or latest-sts"
          fi

  # ============================================================
  # SUMMARY
  # ============================================================
  summary:
    name: "ðŸ“Š Validation Summary"
    runs-on: ubuntu-latest
    needs:
      - numeric-channel-quality-unix
      - numeric-channel-quality-windows
      - alias-channel-quality-ignored-unix
      - alias-channel-quality-ignored-windows
      - prove-quality-ignored
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ“Š Channel + Quality Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Case 1: Numeric Channel + Quality (should work)" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux/macOS | \`${{ needs.numeric-channel-quality-unix.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows (pwsh) | \`${{ needs.numeric-channel-quality-windows.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Case 2: Alias Channel (LTS/STS) + Quality (should be ignored)" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | \`${{ needs.alias-channel-quality-ignored-unix.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows (pwsh) | \`${{ needs.alias-channel-quality-ignored-windows.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Proof (version comparison) | \`${{ needs.prove-quality-ignored.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Conclusions for Issue #497" >> $GITHUB_STEP_SUMMARY
          echo "- **\`dotnet-version: latest\`** â†’ Resolves to numeric channel â†’ \`dotnet-quality\` works âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **\`dotnet-version: latest-lts\`** â†’ Uses alias channel â†’ \`dotnet-quality\` is silently ignored âš ï¸" >> $GITHUB_STEP_SUMMARY
          echo "- **Recommendation:** Warn users when \`dotnet-quality\` is specified alongside \`latest-lts\` or \`latest-sts\`" >> $GITHUB_STEP_SUMMARY
