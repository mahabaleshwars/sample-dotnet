name: Test .NET Install - Latest, Channel & Quality Combinations

on:
  workflow_dispatch:

jobs:
  # ============================================================
  # 1. BASIC LATEST (No channel, no quality)
  # ============================================================
  latest-no-channel-no-quality:
    name: "Latest SDK (no channel, no quality)"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Install latest SDK via install script
        shell: bash
        run: |
          curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin \
            --channel STS \
            --install-dir $HOME/.dotnet-test
          $HOME/.dotnet-test/dotnet --info

      - name: Verify dotnet is functional
        shell: bash
        run: |
          $HOME/.dotnet-test/dotnet --list-sdks
          $HOME/.dotnet-test/dotnet --list-runtimes

  # ============================================================
  # 2. LATEST with NUMERIC CHANNEL (simulating resolved "latest")
  # ============================================================
  latest-numeric-channels:
    name: "Latest SDK - Channel ${{ matrix.channel }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        channel: ['9.0', '10.0']
    steps:
      - name: Install .NET SDK via channel ${{ matrix.channel }}
        shell: bash
        run: |
          curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin \
            --channel ${{ matrix.channel }} \
            --install-dir $HOME/.dotnet-test
          $HOME/.dotnet-test/dotnet --info

      - name: Verify SDK version
        shell: bash
        run: |
          SDK_VERSION=$($HOME/.dotnet-test/dotnet --version)
          echo "Installed SDK version: $SDK_VERSION"
          echo "Expected channel: ${{ matrix.channel }}"
          # Verify the major.minor matches the channel
          if [[ "$SDK_VERSION" == ${{ matrix.channel }}* ]]; then
            echo "âœ… SDK version matches channel ${{ matrix.channel }}"
          else
            echo "âŒ SDK version $SDK_VERSION does not match channel ${{ matrix.channel }}"
            exit 1
          fi

  # ============================================================
  # 3. LATEST + QUALITY (ga, preview, daily)
  # ============================================================
  latest-with-quality:
    name: "Channel ${{ matrix.channel }} + Quality ${{ matrix.quality }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        channel: ['9.0', '10.0']
        quality: ['ga', 'preview', 'daily']
    steps:
      - name: Install .NET SDK (channel=${{ matrix.channel }}, quality=${{ matrix.quality }})
        shell: bash
        run: |
          curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin \
            --channel ${{ matrix.channel }} \
            --quality ${{ matrix.quality }} \
            --install-dir $HOME/.dotnet-test
          $HOME/.dotnet-test/dotnet --info

      - name: Verify installation
        shell: bash
        run: |
          SDK_VERSION=$($HOME/.dotnet-test/dotnet --version)
          echo "Installed SDK version: $SDK_VERSION"
          echo "Channel: ${{ matrix.channel }}, Quality: ${{ matrix.quality }}"
          $HOME/.dotnet-test/dotnet --list-sdks
          $HOME/.dotnet-test/dotnet --list-runtimes

  # ============================================================
  # 4. LATEST + RUNTIME VARIANTS (dotnet, aspnetcore)
  # ============================================================
  latest-runtime-variants:
    name: "Runtime ${{ matrix.runtime }} - Channel ${{ matrix.channel }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        channel: ['9.0', '10.0']
        runtime: ['dotnet', 'aspnetcore']
    steps:
      - name: Install .NET Runtime (${{ matrix.runtime }}, channel=${{ matrix.channel }})
        shell: bash
        run: |
          curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin \
            --runtime ${{ matrix.runtime }} \
            --channel ${{ matrix.channel }} \
            --install-dir $HOME/.dotnet-test
          $HOME/.dotnet-test/dotnet --info

      - name: Verify runtime installation
        shell: bash
        run: |
          echo "Runtime: ${{ matrix.runtime }}, Channel: ${{ matrix.channel }}"
          $HOME/.dotnet-test/dotnet --list-runtimes

  # ============================================================
  # 5. LATEST + RUNTIME + QUALITY
  # ============================================================
  latest-runtime-with-quality:
    name: "Runtime ${{ matrix.runtime }} + Quality ${{ matrix.quality }} - Channel ${{ matrix.channel }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        channel: ['9.0', '10.0']
        runtime: ['dotnet', 'aspnetcore']
        quality: ['ga', 'preview']
    steps:
      - name: Install .NET Runtime (${{ matrix.runtime }}, channel=${{ matrix.channel }}, quality=${{ matrix.quality }})
        shell: bash
        run: |
          curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin \
            --runtime ${{ matrix.runtime }} \
            --channel ${{ matrix.channel }} \
            --quality ${{ matrix.quality }} \
            --install-dir $HOME/.dotnet-test
          $HOME/.dotnet-test/dotnet --info

      - name: Verify runtime installation
        shell: bash
        run: |
          echo "Runtime: ${{ matrix.runtime }}, Channel: ${{ matrix.channel }}, Quality: ${{ matrix.quality }}"
          $HOME/.dotnet-test/dotnet --list-runtimes

  # ============================================================
  # 6. ARCHITECTURE VARIANTS
  # ============================================================
  latest-architecture:
    name: "Channel ${{ matrix.channel }} + Arch ${{ matrix.arch }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            channel: '10.0'
            arch: x64
          - os: ubuntu-latest
            channel: '9.0'
            arch: x64
          - os: macos-latest
            channel: '10.0'
            arch: arm64
          - os: macos-latest
            channel: '9.0'
            arch: arm64
          - os: windows-latest
            channel: '10.0'
            arch: x64
    steps:
      - name: Install .NET SDK (channel=${{ matrix.channel }}, arch=${{ matrix.arch }})
        shell: bash
        run: |
          curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin \
            --channel ${{ matrix.channel }} \
            --architecture ${{ matrix.arch }} \
            --install-dir $HOME/.dotnet-test-${{ matrix.arch }}
          $HOME/.dotnet-test-${{ matrix.arch }}/dotnet --info

      - name: Verify architecture
        shell: bash
        run: |
          echo "Expected architecture: ${{ matrix.arch }}"
          $HOME/.dotnet-test-${{ matrix.arch }}/dotnet --info | grep -i "architecture\|rid\|platform"

  # ============================================================
  # 7. --version latest WITH CHANNEL
  # ============================================================
  version-latest-keyword:
    name: "Version=latest + Channel ${{ matrix.channel }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        channel: ['9.0', '10.0']
    steps:
      - name: Install .NET SDK (--version latest, channel=${{ matrix.channel }})
        shell: bash
        run: |
          curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin \
            --version latest \
            --channel ${{ matrix.channel }} \
            --install-dir $HOME/.dotnet-test
          $HOME/.dotnet-test/dotnet --info

      - name: Verify SDK version
        shell: bash
        run: |
          SDK_VERSION=$($HOME/.dotnet-test/dotnet --version)
          echo "Installed SDK version: $SDK_VERSION"
          if [[ "$SDK_VERSION" == ${{ matrix.channel }}* ]]; then
            echo "âœ… SDK version matches channel ${{ matrix.channel }}"
          else
            echo "âŒ SDK version $SDK_VERSION does not match channel ${{ matrix.channel }}"
            exit 1
          fi

  # ============================================================
  # 8. --version latest + RUNTIME + ARCHITECTURE
  # ============================================================
  version-latest-runtime-arch:
    name: "Version=latest + Runtime ${{ matrix.runtime }} + Arch x64"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        channel: ['9.0', '10.0']
        runtime: ['dotnet', 'aspnetcore']
    steps:
      - name: Install (--version latest, runtime=${{ matrix.runtime }}, channel=${{ matrix.channel }}, arch=x64)
        shell: bash
        run: |
          curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin \
            --runtime ${{ matrix.runtime }} \
            --version latest \
            --channel ${{ matrix.channel }} \
            --architecture x64 \
            --install-dir $HOME/.dotnet-test-x64
          $HOME/.dotnet-test-x64/dotnet --info

      - name: Verify runtime
        shell: bash
        run: |
          echo "Runtime: ${{ matrix.runtime }}, Channel: ${{ matrix.channel }}"
          $HOME/.dotnet-test-x64/dotnet --list-runtimes

  # ============================================================
  # 9. GENERIC LTS/STS CHANNEL + QUALITY (demonstrates the bug)
  # ============================================================
  generic-channel-quality-bug:
    name: "âš ï¸ Bug Demo: Generic ${{ matrix.channel }} + Quality ${{ matrix.quality }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        channel: ['LTS', 'STS']
        quality: ['preview', 'daily', 'ga']
    steps:
      - name: Install .NET SDK (generic channel=${{ matrix.channel }}, quality=${{ matrix.quality }})
        shell: bash
        run: |
          echo "âš ï¸ This demonstrates the bug: quality is SILENTLY IGNORED with generic LTS/STS channels"
          echo "The install script drops --quality when --channel is LTS or STS"
          echo ""
          curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin \
            --channel ${{ matrix.channel }} \
            --quality ${{ matrix.quality }} \
            --install-dir $HOME/.dotnet-test || true

      - name: Show what was actually installed
        shell: bash
        run: |
          if [ -f "$HOME/.dotnet-test/dotnet" ]; then
            echo "Installed version (quality was likely ignored):"
            $HOME/.dotnet-test/dotnet --version
            $HOME/.dotnet-test/dotnet --list-sdks
          else
            echo "Installation may have failed or no dotnet binary found"
          fi

  # ============================================================
  # 10. NEGATIVE TESTS (expected failures)
  # ============================================================
  negative-invalid-quality:
    name: "âŒ Negative: Invalid quality '${{ matrix.quality }}'"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        quality: ['signed', 'validated', 'invalid', 'release']
    steps:
      - name: Attempt install with invalid quality=${{ matrix.quality }} (should fail)
        shell: bash
        run: |
          echo "âŒ Testing invalid quality value: ${{ matrix.quality }}"
          if curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin \
            --channel 10.0 \
            --quality ${{ matrix.quality }} \
            --install-dir $HOME/.dotnet-test 2>&1; then
            echo "âŒ UNEXPECTED: Install succeeded with invalid quality '${{ matrix.quality }}'"
            exit 1
          else
            echo "âœ… EXPECTED: Install correctly rejected invalid quality '${{ matrix.quality }}'"
          fi

  negative-quality-without-channel:
    name: "âŒ Negative: Quality without channel"
    runs-on: ubuntu-latest
    steps:
      - name: Attempt install with quality but no channel (should fail or be ignored)
        shell: bash
        run: |
          echo "âŒ Testing quality without channel"
          curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin \
            --quality preview \
            --install-dir $HOME/.dotnet-test 2>&1 || true
          echo "Check output above â€” quality without channel should be rejected or ignored"

  negative-eol-channel:
    name: "âŒ Negative: EOL channel 6.0"
    runs-on: ubuntu-latest
    steps:
      - name: Install EOL .NET 6.0 (should still work but is end-of-life)
        shell: bash
        run: |
          echo "âš ï¸ Installing EOL channel 6.0 â€” should work but version is end-of-life"
          curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin \
            --channel 6.0 \
            --install-dir $HOME/.dotnet-test
          $HOME/.dotnet-test/dotnet --version
          echo "âœ… EOL channel installed (but should NOT be selected by 'latest')"

  # ============================================================
  # 11. WINDOWS PowerShell TESTS
  # ============================================================
  windows-powershell:
    name: "Windows PS: Channel ${{ matrix.channel }} + Quality ${{ matrix.quality }}"
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - channel: '10.0'
            quality: 'ga'
          - channel: '10.0'
            quality: 'preview'
          - channel: '10.0'
            quality: 'daily'
          - channel: '9.0'
            quality: 'ga'
          - channel: '9.0'
            quality: 'preview'
          - channel: 'LTS'
            quality: 'ga'
    steps:
      - name: Install .NET SDK via PowerShell (channel=${{ matrix.channel }}, quality=${{ matrix.quality }})
        shell: pwsh
        run: |
          $installDir = "$env:USERPROFILE\.dotnet-test"
          Invoke-Expression "& { $(Invoke-RestMethod https://dot.net/v1/dotnet-install.ps1) } -Channel ${{ matrix.channel }} -Quality ${{ matrix.quality }} -InstallDir $installDir"
          & "$installDir\dotnet.exe" --info

      - name: Verify SDK installation
        shell: pwsh
        run: |
          $installDir = "$env:USERPROFILE\.dotnet-test"
          $version = & "$installDir\dotnet.exe" --version
          Write-Host "Installed SDK version: $version"
          Write-Host "Channel: ${{ matrix.channel }}, Quality: ${{ matrix.quality }}"
          & "$installDir\dotnet.exe" --list-sdks
          & "$installDir\dotnet.exe" --list-runtimes

  windows-powershell-runtime:
    name: "Windows PS: Runtime ${{ matrix.runtime }} + Channel ${{ matrix.channel }}"
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - runtime: 'dotnet'
            channel: '10.0'
            quality: 'ga'
          - runtime: 'aspnetcore'
            channel: '10.0'
            quality: 'preview'
          - runtime: 'dotnet'
            channel: '9.0'
            quality: 'ga'
    steps:
      - name: Install .NET Runtime via PowerShell
        shell: pwsh
        run: |
          $installDir = "$env:USERPROFILE\.dotnet-test"
          Invoke-Expression "& { $(Invoke-RestMethod https://dot.net/v1/dotnet-install.ps1) } -Runtime ${{ matrix.runtime }} -Channel ${{ matrix.channel }} -Quality ${{ matrix.quality }} -InstallDir $installDir"
          & "$installDir\dotnet.exe" --info

      - name: Verify runtime installation
        shell: pwsh
        run: |
          $installDir = "$env:USERPROFILE\.dotnet-test"
          Write-Host "Runtime: ${{ matrix.runtime }}, Channel: ${{ matrix.channel }}, Quality: ${{ matrix.quality }}"
          & "$installDir\dotnet.exe" --list-runtimes

  # ============================================================
  # 12. SUMMARY JOB
  # ============================================================
  summary:
    name: "ðŸ“Š Test Summary"
    runs-on: ubuntu-latest
    needs:
      - latest-no-channel-no-quality
      - latest-numeric-channels
      - latest-with-quality
      - latest-runtime-variants
      - latest-runtime-with-quality
      - latest-architecture
      - version-latest-keyword
      - version-latest-runtime-arch
      - generic-channel-quality-bug
      - negative-invalid-quality
      - negative-quality-without-channel
      - negative-eol-channel
      - windows-powershell
      - windows-powershell-runtime
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ï¿½ï¿½ .NET Install Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Latest (no channel/quality) | \`${{ needs.latest-no-channel-no-quality.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Numeric Channels | \`${{ needs.latest-numeric-channels.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Channel + Quality | \`${{ needs.latest-with-quality.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Runtime Variants | \`${{ needs.latest-runtime-variants.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Runtime + Quality | \`${{ needs.latest-runtime-with-quality.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | \`${{ needs.latest-architecture.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| --version latest | \`${{ needs.version-latest-keyword.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| --version latest + Runtime | \`${{ needs.version-latest-runtime-arch.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| âš ï¸ Generic LTS/STS + Quality Bug | \`${{ needs.generic-channel-quality-bug.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Invalid Quality | \`${{ needs.negative-invalid-quality.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Quality without Channel | \`${{ needs.negative-quality-without-channel.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ EOL Channel | \`${{ needs.negative-eol-channel.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows PowerShell | \`${{ needs.windows-powershell.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows PS Runtime | \`${{ needs.windows-powershell-runtime.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Key Findings" >> $GITHUB_STEP_SUMMARY
          echo "- **Numeric channels** (e.g., \`10.0\`) honor \`--quality\` âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Generic channels** (\`LTS\`/\`STS\`) silently ignore \`--quality\` âš ï¸" >> $GITHUB_STEP_SUMMARY
          echo "- **Invalid quality values** (\`signed\`, \`validated\`) should be rejected âŒ" >> $GITHUB_STEP_SUMMARY
