name: Architecture Input PR E2E Test

on:
  workflow_dispatch:

jobs:
  architecture-matrix:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        architecture: [x64, x86, arm64]
        exclude:
          # Exclude known-unsupported combos
          - os: macos-latest
            architecture: x86
          - os: windows-latest
            architecture: arm64
          - os: ubuntu-latest
            architecture: x86

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Clear .NET toolcache
        shell: pwsh
        run: |
          if ($env:RUNNER_OS -eq "Windows") {
            Remove-Item -Path "$env:USERPROFILE\.dotnet" -Recurse -Force -ErrorAction SilentlyContinue
          } else {
            rm -rf $HOME/.dotnet || true
          }

      - name: Setup .NET with architecture (${{ matrix.architecture }})
        uses: priya-kinthali/setup-dotnet@add-architecture-support
        with:
          dotnet-version: 8.0.x
          architecture: ${{ matrix.architecture }}

      - name: Print dotnet info
        run: dotnet --info

      - name: List installed SDKs
        run: dotnet --list-sdks

      - name: List installed runtimes
        run: dotnet --list-runtimes

      - name: Check cross-arch install dir
        run: |
          if [ -d "$HOME/.dotnet/${{ matrix.architecture }}" ]; then
            echo "Found cross-arch install dir: $HOME/.dotnet/${{ matrix.architecture }}"
          else
            echo "Cross-arch install dir missing or not applicable for this platform/arch"
          fi
        shell: bash

  invalid-architecture:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Clear .NET toolcache
        shell: pwsh
        run: rm -rf $HOME/.dotnet || true

      - name: Test action with invalid architecture
        id: invalid_arch
        continue-on-error: true
        uses: priya-kinthali/setup-dotnet@add-architecture-support
        with:
          dotnet-version: 8.0.x
          architecture: fooarch

      - name: Assert error on invalid architecture
        if: steps.invalid_arch.outcome == 'failure'
        run: echo "Correctly failed on unsupported architecture input."

  native-no-architecture:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Clear .NET toolcache
        shell: bash
        run: rm -rf $HOME/.dotnet || true

      - name: Test action with default auto arch
        uses: priya-kinthali/setup-dotnet@add-architecture-support
        with:
          dotnet-version: 8.0.x

      - name: Print dotnet info
        run: dotnet --info
