name: Platform-aware Architecture Input E2E Test

on:
  workflow_dispatch:

jobs:
  supported-architectures-matrix:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows: x64, x86, arm64, arm
          - os: windows-latest
            architecture: x64
          - os: windows-latest
            architecture: x86
          - os: windows-latest
            architecture: arm64
          - os: windows-latest
            architecture: arm
          # Linux: x64, arm64, arm, s390x, ppc64le
          - os: ubuntu-latest
            architecture: x64
          - os: ubuntu-latest
            architecture: arm64
          - os: ubuntu-latest
            architecture: arm
          - os: ubuntu-latest
            architecture: s390x
          - os: ubuntu-latest
            architecture: ppc64le
          # macOS: x64, arm64
          - os: macos-latest
            architecture: x64
          - os: macos-latest
            architecture: arm64

    steps:
      - uses: actions/checkout@v6

      - name: Clear .NET toolcache
        shell: pwsh
        run: |
          if ($env:RUNNER_OS -eq "Windows") {
            Remove-Item -Path "$env:USERPROFILE\.dotnet" -Recurse -Force -ErrorAction SilentlyContinue
          } else {
            rm -rf $HOME/.dotnet || true
          }

      - name: Setup .NET with valid architecture (${{ matrix.architecture }})
        uses: priya-kinthali/setup-dotnet@add-architecture-support
        with:
          dotnet-version: 8.0.x
          architecture: ${{ matrix.architecture }}

      - name: List installed SDKs
        run: dotnet --list-sdks || true

      - name: List installed runtimes
        run: dotnet --list-runtimes || true

      - name: Assert install dir created
        shell: bash
        run: |
          echo "Checking for install dir: $HOME/.dotnet/${{ matrix.architecture }}"
          if [ -d "$HOME/.dotnet/${{ matrix.architecture }}" ]; then
            echo "Install dir for arch present."
          else
            echo "Install dir may not be created for native arch or by script logic."
          fi

  windows-unsupported-arch:
    runs-on: windows-latest
    strategy:
      matrix:
        architecture: [s390x, ppc64le, riscv64]
    steps:
      - uses: actions/checkout@v6

      - name: Clear .NET toolcache
        shell: pwsh
        run: Remove-Item -Path "$env:USERPROFILE\.dotnet" -Recurse -Force -ErrorAction SilentlyContinue

      - name: Windows unsupported arch (${{ matrix.architecture }}) should fail
        id: setup
        uses: priya-kinthali/setup-dotnet@add-architecture-support
        with:
          dotnet-version: 8.0.x
          architecture: ${{ matrix.architecture }}
        continue-on-error: true

      - name: Assert expected failure for Windows unsupported arch
        if: steps.setup.outcome == 'failure'
        run: echo "Correctly failed on unsupported Windows architecture: ${{ matrix.architecture }}"

  linux-unsupported-arch:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        architecture: [x86, riscv64]
    steps:
      - uses: actions/checkout@v6

      - name: Clear .NET toolcache
        shell: bash
        run: rm -rf $HOME/.dotnet || true

      - name: Linux unsupported arch (${{ matrix.architecture }}) should fail
        id: setup
        uses: priya-kinthali/setup-dotnet@add-architecture-support
        with:
          dotnet-version: 8.0.x
          architecture: ${{ matrix.architecture }}
        continue-on-error: true

      - name: Assert expected failure for Linux unsupported arch
        if: steps.setup.outcome == 'failure'
        run: echo "Correctly failed on unsupported Linux architecture: ${{ matrix.architecture }}"

  macos-unsupported-arch:
    runs-on: macos-latest
    strategy:
      matrix:
        architecture: [x86, s390x, ppc64le, riscv64]
    steps:
      - uses: actions/checkout@v6

      - name: Clear .NET toolcache
        shell: bash
        run: rm -rf $HOME/.dotnet || true

      - name: MacOS unsupported arch (${{ matrix.architecture }}) should fail
        id: setup
        uses: priya-kinthali/setup-dotnet@add-architecture-support
        with:
          dotnet-version: 8.0.x
          architecture: ${{ matrix.architecture }}
        continue-on-error: true

      - name: Assert expected failure for MacOS unsupported arch
        if: steps.setup.outcome == 'failure'
        run: echo "Correctly failed on unsupported MacOS architecture: ${{ matrix.architecture }}"
